# Kimai Aggregator

Веб-приложение и десктопное приложение (Electron) для агрегации и анализа данных из Kimai - системы учета рабочего времени.

## Возможности

- Подключение к Kimai API через URL и API ключ
- **Динамическая загрузка проектов** из Kimai - система автоматически подхватывает все ваши проекты
- Настройка ставки оплаты за минуту работы
- **Гибкая настройка параметров для каждого проекта**:
  - Включение/выключение отслеживания
  - Цель по часам в неделю (опционально)
  - Периоды оплаты с итеративным расчетом от начальной недели
  - Этапы проекта с датами начала и окончания
- Агрегация данных по неделям
- Раздельные страницы для разных типов данных:
  - Дашборд с прогрессом текущей недели
  - Таблица времени с детализацией
  - Финансовые отчеты
- **Экспорт и импорт настроек** - сохраните свои настройки проектов в JSON файл
- **Синхронизация настроек по URL** - синхронизируйте настройки между устройствами
- **Темная тема** по умолчанию
- **Electron приложение** - используйте как полноценное десктопное приложение
- **Синхронизация с календарями** - синхронизация записей времени с Google Calendar или Notion Calendar

## Установка

```bash
npm install
```

## Запуск

### Веб-версия (разработка)
```bash
npm run dev
```

### Electron (разработка)
```bash
npm run electron:dev
```

### Сборка Electron приложения
```bash
npm run electron:build
```

## Настройка

1. Откройте приложение
2. Перейдите в раздел "Настройки"
3. Заполните:
   - URL вашего Kimai сервера
   - API ключ (можно получить в профиле пользователя Kimai)
   - Ставку за минуту работы
4. Если возникают ошибки CORS в режиме разработки:
   - Создайте файл `.env` в корне проекта
   - Добавьте строку: `VITE_KIMAI_URL=https://ваш-kimai-сервер.com`
   - Включите опцию "Использовать прокси для обхода CORS" в настройках
   - Перезапустите dev-сервер (`npm run dev`)
5. После сохранения API настроек система автоматически загрузит список ваших проектов из Kimai
6. Для каждого проекта настройте параметры:
   - Включить/выключить отслеживание
   - Настроить цель по часам (если нужно)
   - Настроить периоды оплаты (если нужно) - укажите номер недели и год начала первого периода
   - Настроить этапы проекта (если нужно) - добавьте этапы с датами и плановыми часами

Настройки сохраняются в localStorage браузера (или в Electron - в пользовательской директории).

### Экспорт и импорт настроек

Вы можете экспортировать все настройки (включая параметры проектов) в JSON файл и импортировать их обратно. Это полезно для:
- Резервного копирования настроек
- Переноса настроек между устройствами
- Сохранения конфигурации при переустановке

### Синхронизация по URL

Вы можете настроить URL для синхронизации настроек. Это позволяет синхронизировать настройки между несколькими устройствами:
1. Экспортируйте настройки на одном устройстве
2. Загрузите JSON файл на веб-сервер или используйте сервис для обмена файлами
3. Укажите URL этого файла в настройках на других устройствах
4. Нажмите "Импорт из URL" для синхронизации

## Использование

После настройки API используйте боковое меню для навигации:
- **Дашборд** - прогресс текущей недели и общая статистика
- **Таблица времени** - детальная таблица с записями времени по неделям
- **Финансы** - финансовые отчеты по неделям и периодам
- **Календарь** - визуализация записей времени в календарном виде
- **Настройки** - конфигурация приложения

### Синхронизация с календарями

Приложение поддерживает синхронизацию записей времени с внешними календарями:

#### Google Calendar

1. Перейдите в **Настройки** → **Синхронизация календаря**
2. Включите синхронизацию и выберите "Google Calendar"
3. Создайте проект в [Google Cloud Console](https://console.cloud.google.com/)
4. Включите Google Calendar API
5. Создайте OAuth 2.0 credentials (Client ID и Client Secret)
6. Добавьте redirect URI: `http://localhost:5173/oauth/callback` (для dev) или ваш домен
7. Введите Client ID и Client Secret в настройках
8. Нажмите "Авторизовать Google Calendar"
9. На странице **Календарь** нажмите "Синхронизировать календарь"

#### Notion Calendar

**Важно:** Синхронизация с Notion работает только в Electron приложении из-за ограничений CORS браузера. Используйте `npm run electron:dev` для запуска.

1. Перейдите в **Настройки** → **Синхронизация календаря**
2. Включите синхронизацию и выберите "Notion Calendar"
3. Создайте интеграцию в Notion (Settings & Members → Integrations → New integration)
4. Скопируйте Internal Integration Token
5. Создайте базу данных в Notion с полями:
   - Name (Title)
   - Date (Date)
   - Duration (Number)
   - Project (Text)
   - Activity (Text)
   - Kimai ID (Number)
   - Description (Text, опционально)
6. Предоставьте доступ интеграции к базе данных
7. Скопируйте Database ID из URL страницы базы данных
8. Введите API Key и Database ID в настройках
9. На странице **Календарь** нажмите "Синхронизировать календарь"

## Решение проблем с CORS

Если вы видите ошибки CORS при работе с API:

**В режиме разработки:**
1. Создайте файл `.env` в корне проекта
2. Добавьте: `VITE_KIMAI_URL=https://ваш-kimai-сервер.com`
3. Включите опцию "Использовать прокси" в настройках
4. Перезапустите dev-сервер

**В production:**
- Настройте CORS на сервере Kimai, разрешив запросы с вашего домена
- Или используйте Electron версию приложения, которая не имеет ограничений CORS

## Структура проекта

```
├── src/
│   ├── components/     # React компоненты
│   ├── pages/         # Страницы приложения
│   ├── hooks/         # React хуки
│   ├── services/      # API клиент и бизнес-логика
│   └── App.jsx        # Главный компонент
├── electron/          # Electron конфигурация
└── package.json
```

## Docker

### Сборка образа

```bash
docker build -t kimai-aggregator:latest .
```

### Запуск через Docker

```bash
docker run -d \
  -p 80:80 \
  --name kimai-aggregator \
  kimai-aggregator:latest
```

## Лицензия

Copyright (C) 2025 Localzet Group

This program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
